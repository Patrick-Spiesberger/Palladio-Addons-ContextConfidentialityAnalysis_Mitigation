package edu.kit.ipd.sdq.kamp4attack.core;

import java.util.HashSet;
import java.util.Set;

import org.eclipse.emf.common.notify.Notification;
import org.eclipse.emf.common.notify.impl.AdapterImpl;
import org.palladiosimulator.pcm.core.entity.Entity;

import edu.kit.ipd.sdq.kamp4attack.model.modificationmarks.KAMP4attackModificationmarks.CredentialChange;
import edu.kit.ipd.sdq.kamp4attack.model.modificationmarks.KAMP4attackModificationmarks.KAMP4attackModificationmarksPackage;

public class CacheVulnerability {

    private Set<String> compromised = new HashSet<>();

    private static CacheVulnerability cache = new CacheVulnerability();

    private CacheVulnerability() {
        // TODO Auto-generated constructor stub
    }

    public static CacheVulnerability instance() {
        return cache;
    }

    public void addEntity(Entity entity) {
        if (entity.getId() != null) {
            this.compromised.add(entity.getId());
        }
    }

    public boolean checkedBefore(Entity entity) {
        if (entity.getId() != null) {
            return this.compromised.contains(entity.getId());
        }
        return false;
    }

    public void reset() {
        this.compromised.clear();
    }

    public void register(CredentialChange change) {
        var adapter = new AdapterImpl() {
            @Override
            public void notifyChanged(Notification notification) {
                if (notification.getEventType() == Notification.SET && notification.getFeatureID(
                        CredentialChange.class) == KAMP4attackModificationmarksPackage.CREDENTIAL_CHANGE__CHANGED) {
                    reset();
                }
            }
        };

        change.eAdapters().add(adapter);
    }

}
